version: "3.8"

# Environment file selection:
# - Development: docker compose --env-file .env.development up -d
# - Production:  docker compose --env-file .env up -d
# Default: .env.development (for local development)

services:
  mqtt:
    image: eclipse-mosquitto:latest
    container_name: rouptimize-mqtt
    ports:
      - "${MQTT_PORT:-1883}:1883" # Standard MQTT
      - "${MQTT_WS_PORT:-9001}:9001" # WebSocket (for mobile app)
    volumes:
      - ./mosquitto/config:/mosquitto/config:ro
      - mosquitto_data:/mosquitto/data
      - mosquitto_logs:/mosquitto/log
    healthcheck:
      test:
        [
          "CMD",
          "mosquitto_sub",
          "-t",
          "$$SYS/#",
          "-C",
          "1",
          "-i",
          "healthcheck",
          "-W",
          "3",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: rouptimize-clickhouse
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123" # HTTP interface
      - "${CLICKHOUSE_TCP_PORT:-9000}:9000" # Native TCP interface
    environment:
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-123456}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

volumes:
  clickhouse_data:
  clickhouse_logs:
  mosquitto_data:
  mosquitto_logs:
